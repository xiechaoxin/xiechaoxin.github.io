<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>sso-intro - xcx</title><meta name="description" content=""><meta property="og:title" content="sso-intro" />
<meta property="og:description" content="SSO 单点登录 本文授权转载自 ： https://ken.io/note/sso-design-implement 作者：ken.io 相关推荐阅读：系统的讲解 - SSO单点登录 1 一、前言 1.1 、SSO说明 SSO英文全称Single Sign O" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xiechaoxin.github.io/posts/pro/security/sso-intro/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-17T17:59:13+00:00" />
<meta property="article:modified_time" content="2022-06-17T17:59:13+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="sso-intro"/>
<meta name="twitter:description" content="SSO 单点登录 本文授权转载自 ： https://ken.io/note/sso-design-implement 作者：ken.io 相关推荐阅读：系统的讲解 - SSO单点登录 1 一、前言 1.1 、SSO说明 SSO英文全称Single Sign O"/>
<meta name="application-name" content="xcx">
<meta name="apple-mobile-web-app-title" content="xcx"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://xiechaoxin.github.io/posts/pro/security/sso-intro/" /><link rel="prev" href="https://xiechaoxin.github.io/posts/chaos/%E5%A4%A7%E4%BD%AC%E5%88%86%E4%BA%AB/interview/technical-preliminary-preparation/" /><link rel="next" href="https://xiechaoxin.github.io/posts/chaos/%E5%A4%A7%E4%BD%AC%E5%88%86%E4%BA%AB/advanced-programmer/seven-tips-for-becoming-an-advanced-programmer/" /><link rel="stylesheet" href="/css/page.min.css"><link rel="stylesheet" href="/css/home.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "sso-intro",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/xiechaoxin.github.io\/posts\/pro\/security\/sso-intro\/"
        },"genre": "posts","keywords": "system_design, security","wordcount":  1684 ,
        "url": "https:\/\/xiechaoxin.github.io\/posts\/pro\/security\/sso-intro\/","datePublished": "2022-06-17T17:59:13+00:00","dateModified": "2022-06-17T17:59:13+00:00","publisher": {
            "@type": "Organization",
            "name": "作者"},"author": {
                "@type": "Person",
                "name": "作者"
            },"description": ""
    }
    </script></head><body data-header-desktop="" data-header-mobile=""><script>(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="xcx">xcx</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="在客户端搜索可能比较慢~" id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="xcx">xcx</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="在客户端搜索可能比较慢~" id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><div class="menu-item"><a href="#" onclick="return false;" class="theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div></div>
    </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single" data-toc="disable"><div class="single-card" ><h2 class="single-title animated flipInX">sso-intro</h2><div class="post-meta">
                <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>作者</a></span>&nbsp;<span class="post-category">出版于  <a href="/categories/system_design/"><i class="far fa-folder fa-fw"></i>system_design</a></span></div>
                <div class="post-meta-line"><span><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-06-17">2022-06-17</time></span>&nbsp;<span><i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 1684 字</span>&nbsp;
                    <span><i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 4 分钟</span>&nbsp;</div>
            </div>
            
            <hr><div class="details toc" id="toc-static"  data-kept="">
                    <div class="details-summary toc-title">
                        <span>目录</span>
                        <span><i class="details-icon fas fa-angle-right"></i></span>
                    </div>
                    <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-一前言">1 一、前言</a>
      <ul>
        <li><a href="#11-sso说明">1.1 、SSO说明</a></li>
        <li><a href="#12-单点登录系统的好处">1.2 、单点登录系统的好处</a></li>
        <li><a href="#13-设计目标">1.3 、设计目标</a></li>
      </ul>
    </li>
    <li><a href="#2-二sso设计与实现">2 二、SSO设计与实现</a>
      <ul>
        <li><a href="#21-核心应用与依赖">2.1 、核心应用与依赖</a></li>
        <li><a href="#22-用户登录状态的存储与校验">2.2 、用户登录状态的存储与校验</a></li>
        <li><a href="#23-用户登录登录校验">2.3 、用户登录/登录校验</a></li>
        <li><a href="#24-用户登出">2.4 、用户登出</a></li>
        <li><a href="#25-跨域登录登出">2.5 、跨域登录、登出</a></li>
      </ul>
    </li>
    <li><a href="#3-三备注">3 三、备注</a></li>
  </ul>
</nav></div>
                </div><div class="content" id="content"><h1 id="sso-单点登录">SSO 单点登录</h1>
<blockquote>
<p>本文授权转载自 ： <a href="https://ken.io/note/sso-design-implement" target="_blank" rel="noopener noreffer">https://ken.io/note/sso-design-implement</a> 作者：ken.io</p>
<p>相关推荐阅读：<strong><a href="https://www.imooc.com/article/286710" target="_blank" rel="noopener noreffer">系统的讲解 - SSO单点登录</a></strong></p>
</blockquote>
<h2 id="1-一前言">1 一、前言</h2>
<h3 id="11-sso说明">1.1 、SSO说明</h3>
<p>SSO英文全称Single Sign On，单点登录。SSO是在多个应用系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。https://baike.baidu.com/item/SSO/3451380</p>
<p>例如访问在网易账号中心(<a href="https://reg.163.com/" target="_blank" rel="noopener noreffer">https://reg.163.com/</a> )登录之后
访问以下站点都是登录状态</p>
<ul>
<li>网易直播 <a href="https://v.163.com/" target="_blank" rel="noopener noreffer">https://v.163.com</a></li>
<li>网易博客 <a href="https://blog.163.com/" target="_blank" rel="noopener noreffer">https://blog.163.com</a></li>
<li>网易花田 <a href="https://love.163.com/" target="_blank" rel="noopener noreffer">https://love.163.com</a></li>
<li>网易考拉 <a href="https://www.kaola.com/" target="_blank" rel="noopener noreffer">https://www.kaola.com</a></li>
<li>网易Lofter <a href="http://www.lofter.com/" target="_blank" rel="noopener noreffer">http://www.lofter.com</a></li>
</ul>
<h3 id="12-单点登录系统的好处">1.2 、单点登录系统的好处</h3>
<ol>
<li><strong>用户角度</strong> :用户能够做到一次登录多次使用，无需记录多套用户名和密码，省心。</li>
<li><strong>系统管理员角度</strong> : 管理员只需维护好一个统一的账号中心就可以了，方便。</li>
<li><strong>新系统开发角度:</strong> 新系统开发时只需直接对接统一的账号中心即可，简化开发流程，省时。</li>
</ol>
<h3 id="13-设计目标">1.3 、设计目标</h3>
<p>本篇文章也主要是为了探讨如何设计&amp;实现一个SSO系统</p>
<p>以下为需要实现的核心功能：</p>
<ul>
<li>单点登录</li>
<li>单点登出</li>
<li>支持跨域单点登录</li>
<li>支持跨域单点登出</li>
</ul>
<h2 id="2-二sso设计与实现">2 二、SSO设计与实现</h2>
<h3 id="21-核心应用与依赖">2.1 、核心应用与依赖</h3>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./sso-system.png-kblb.png"
        data-srcset="./sso-system.png-kblb.png, ./sso-system.png-kblb.png 1.5x, ./sso-system.png-kblb.png 2x"
        data-sizes="auto"
        alt="./sso-system.png-kblb.png"
        title="单点登录(SSO)设计" /></p>
<table>
<thead>
<tr>
<th>应用/模块/对象</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>前台站点</td>
<td>需要登录的站点</td>
</tr>
<tr>
<td>SSO站点-登录</td>
<td>提供登录的页面</td>
</tr>
<tr>
<td>SSO站点-登出</td>
<td>提供注销登录的入口</td>
</tr>
<tr>
<td>SSO服务-登录</td>
<td>提供登录服务</td>
</tr>
<tr>
<td>SSO服务-登录状态</td>
<td>提供登录状态校验/登录信息查询的服务</td>
</tr>
<tr>
<td>SSO服务-登出</td>
<td>提供用户注销登录的服务</td>
</tr>
<tr>
<td>数据库</td>
<td>存储用户账户信息</td>
</tr>
<tr>
<td>缓存</td>
<td>存储用户的登录信息，通常使用Redis</td>
</tr>
</tbody>
</table>
<h3 id="22-用户登录状态的存储与校验">2.2 、用户登录状态的存储与校验</h3>
<p>常见的Web框架对于<a href="https://ken.io/note/session-principle-skill" target="_blank" rel="noopener noreffer">Session</a>的实现都是生成一个SessionId存储在浏览器Cookie中。然后将Session内容存储在服务器端内存中，这个 ken.io 在之前<a href="https://ken.io/note/session-principle-skill" target="_blank" rel="noopener noreffer">Session工作原理</a>中也提到过。整体也是借鉴这个思路。
用户登录成功之后，生成AuthToken交给客户端保存。如果是浏览器，就保存在Cookie中。如果是手机App就保存在App本地缓存中。本篇主要探讨基于Web站点的SSO。
用户在浏览需要登录的页面时，客户端将AuthToken提交给SSO服务校验登录状态/获取用户登录信息</p>
<p>对于登录信息的存储，建议采用Redis，使用Redis集群来存储登录信息，既可以保证高可用，又可以线性扩充。同时也可以让SSO服务满足负载均衡/可伸缩的需求。</p>
<table>
<thead>
<tr>
<th>对象</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AuthToken</td>
<td>直接使用UUID/GUID即可，如果有验证AuthToken合法性需求，可以将UserName+时间戳加密生成，服务端解密之后验证合法性</td>
</tr>
<tr>
<td>登录信息</td>
<td>通常是将UserId，UserName缓存起来</td>
</tr>
</tbody>
</table>
<h3 id="23-用户登录登录校验">2.3 、用户登录/登录校验</h3>
<ul>
<li>登录时序图</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./sso-login-sequence.png-kbrb.png"
        data-srcset="./sso-login-sequence.png-kbrb.png, ./sso-login-sequence.png-kbrb.png 1.5x, ./sso-login-sequence.png-kbrb.png 2x"
        data-sizes="auto"
        alt="./sso-login-sequence.png-kbrb.png"
        title="SSO系统设计-登录时序图" /></p>
<p>按照上图，用户登录后AuthToken保存在Cookie中。 domain=test.com
浏览器会将domain设置成 .test.com，
这样访问所有*.test.com的web站点，都会将AuthToken携带到服务器端。
然后通过SSO服务，完成对用户状态的校验/用户登录信息的获取</p>
<ul>
<li>登录信息获取/登录状态校验</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./sso-logincheck-sequence.png-kbrb.png"
        data-srcset="./sso-logincheck-sequence.png-kbrb.png, ./sso-logincheck-sequence.png-kbrb.png 1.5x, ./sso-logincheck-sequence.png-kbrb.png 2x"
        data-sizes="auto"
        alt="./sso-logincheck-sequence.png-kbrb.png"
        title="SSO系统设计-登录信息获取/登录状态校验" /></p>
<h3 id="24-用户登出">2.4 、用户登出</h3>
<p>用户登出时要做的事情很简单：</p>
<ol>
<li>服务端清除缓存(Redis)中的登录状态</li>
<li>客户端清除存储的AuthToken</li>
</ol>
<ul>
<li>登出时序图</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./sso-logout-sequence.png-kbrb.png"
        data-srcset="./sso-logout-sequence.png-kbrb.png, ./sso-logout-sequence.png-kbrb.png 1.5x, ./sso-logout-sequence.png-kbrb.png 2x"
        data-sizes="auto"
        alt="./sso-logout-sequence.png-kbrb.png"
        title="SSO系统设计-用户登出" /></p>
<h3 id="25-跨域登录登出">2.5 、跨域登录、登出</h3>
<p>前面提到过，核心思路是客户端存储AuthToken，服务器端通过Redis存储登录信息。由于客户端是将AuthToken存储在Cookie中的。所以跨域要解决的问题，就是如何解决Cookie的跨域读写问题。</p>
<blockquote>
<p><strong>Cookie是不能跨域的</strong> ，比如我一个</p>
</blockquote>
<p>解决跨域的核心思路就是：</p>
<ul>
<li>登录完成之后通过回调的方式，将AuthToken传递给主域名之外的站点，该站点自行将AuthToken保存在当前域下的Cookie中。</li>
<li>登出完成之后通过回调的方式，调用非主域名站点的登出页面，完成设置Cookie中的AuthToken过期的操作。</li>
<li>跨域登录(主域名已登录)</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./sso-crossdomain-login-loggedin-sequence.png-kbrb.png"
        data-srcset="./sso-crossdomain-login-loggedin-sequence.png-kbrb.png, ./sso-crossdomain-login-loggedin-sequence.png-kbrb.png 1.5x, ./sso-crossdomain-login-loggedin-sequence.png-kbrb.png 2x"
        data-sizes="auto"
        alt="./sso-crossdomain-login-loggedin-sequence.png-kbrb.png"
        title="SSO系统设计-跨域登录(主域名已登录)" /></p>
<ul>
<li>跨域登录(主域名未登录)</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./sso-crossdomain-login-unlogin-sequence.png-kbrb.png"
        data-srcset="./sso-crossdomain-login-unlogin-sequence.png-kbrb.png, ./sso-crossdomain-login-unlogin-sequence.png-kbrb.png 1.5x, ./sso-crossdomain-login-unlogin-sequence.png-kbrb.png 2x"
        data-sizes="auto"
        alt="./sso-crossdomain-login-unlogin-sequence.png-kbrb.png"
        title="SSO系统设计-跨域登录(主域名未登录)" /></p>
<ul>
<li>跨域登出</li>
</ul>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="./sso-crossdomain-logout-sequence.png-kbrb.png"
        data-srcset="./sso-crossdomain-logout-sequence.png-kbrb.png, ./sso-crossdomain-logout-sequence.png-kbrb.png 1.5x, ./sso-crossdomain-logout-sequence.png-kbrb.png 2x"
        data-sizes="auto"
        alt="./sso-crossdomain-logout-sequence.png-kbrb.png"
        title="SSO系统设计-跨域登出" /></p>
<h2 id="3-三备注">3 三、备注</h2>
<ul>
<li>关于方案</li>
</ul>
<p>这次设计方案更多是提供实现思路。如果涉及到APP用户登录等情况，在访问SSO服务时，增加对APP的签名验证就好了。当然，如果有无线网关，验证签名不是问题。</p>
<ul>
<li>关于时序图</li>
</ul>
<p>时序图中并没有包含所有场景，ken.io只列举了核心/主要场景，另外对于一些不影响理解思路的消息能省就省了。</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info"><div class="post-info-tag"><span><a href="/tags/system_design/">system_design</a>
                </span><span><a href="/tags/security/">security</a>
                </span></div><div class="post-info-line"><div class="post-info-mod">
                <span>更新于 2022-06-17</span>
            </div><div class="post-info-mod"></div>
        </div></div><div class="post-nav"><a href="/posts/chaos/%E5%A4%A7%E4%BD%AC%E5%88%86%E4%BA%AB/interview/technical-preliminary-preparation/" class="prev" rel="prev" title="technical-preliminary-preparation"><i class="fas fa-angle-left fa-fw"></i>Previous Post</a>
            <a href="/posts/chaos/%E5%A4%A7%E4%BD%AC%E5%88%86%E4%BA%AB/advanced-programmer/seven-tips-for-becoming-an-advanced-programmer/" class="next" rel="next" title="seven-tips-for-becoming-an-advanced-programmer">Next Post<i class="fas fa-angle-right fa-fw"></i></a></div></div>
</div></article></div>
            </main>
            <footer class="footer"><div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.112.4">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/khusika/FeelIt" target="_blank" rel="noopener noreffer" title="FeelIt 1.0.1"><i class="fas fa-hand-holding-heart fa-fw"></i> FeelIt</a>
        </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/"></a></span></div>
</div>
</footer>
        </div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-chevron-up fa-fw"></i>
            </a></div><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script src="/lib/autocomplete/autocomplete.min.js"></script><script src="/lib/lunr/lunr.min.js"></script><script src="/lib/lunr/lunr.stemmer.support.min.js"></script><script src="/lib/lunr/lunr.zh.min.js"></script><script src="/lib/lazysizes/lazysizes.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js"></script></body></html>
